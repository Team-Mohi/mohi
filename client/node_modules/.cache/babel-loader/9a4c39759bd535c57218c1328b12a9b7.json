{"ast":null,"code":"import { Util, Evented } from 'leaflet';\nimport { cors } from '../Support';\nimport { cleanUrl, getUrlParams } from '../Util';\nimport Request from '../Request';\nexport var Service = Evented.extend({\n  options: {\n    proxy: false,\n    useCors: cors,\n    timeout: 0\n  },\n  initialize: function initialize(options) {\n    options = options || {};\n    this._requestQueue = [];\n    this._authenticating = false;\n    Util.setOptions(this, options);\n    this.options.url = cleanUrl(this.options.url);\n  },\n  get: function get(path, params, callback, context) {\n    return this._request('get', path, params, callback, context);\n  },\n  post: function post(path, params, callback, context) {\n    return this._request('post', path, params, callback, context);\n  },\n  request: function request(path, params, callback, context) {\n    return this._request('request', path, params, callback, context);\n  },\n  metadata: function metadata(callback, context) {\n    return this._request('get', '', {}, callback, context);\n  },\n  authenticate: function authenticate(token) {\n    this._authenticating = false;\n    this.options.token = token;\n\n    this._runQueue();\n\n    return this;\n  },\n  getTimeout: function getTimeout() {\n    return this.options.timeout;\n  },\n  setTimeout: function setTimeout(timeout) {\n    this.options.timeout = timeout;\n  },\n  _request: function _request(method, path, params, callback, context) {\n    this.fire('requeststart', {\n      url: this.options.url + path,\n      params: params,\n      method: method\n    }, true);\n\n    var wrappedCallback = this._createServiceCallback(method, path, params, callback, context);\n\n    if (this.options.token) {\n      params.token = this.options.token;\n    }\n\n    if (this.options.requestParams) {\n      Util.extend(params, this.options.requestParams);\n    }\n\n    if (this._authenticating) {\n      this._requestQueue.push([method, path, params, callback, context]);\n\n      return;\n    } else {\n      var url = this.options.proxy ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\n\n      if ((method === 'get' || method === 'request') && !this.options.useCors) {\n        return Request.get.JSONP(url, params, wrappedCallback, context);\n      } else {\n        return Request[method](url, params, wrappedCallback, context);\n      }\n    }\n  },\n  _createServiceCallback: function _createServiceCallback(method, path, params, callback, context) {\n    return Util.bind(function (error, response) {\n      if (error && (error.code === 499 || error.code === 498)) {\n        this._authenticating = true;\n\n        this._requestQueue.push([method, path, params, callback, context]); // fire an event for users to handle and re-authenticate\n\n\n        this.fire('authenticationrequired', {\n          authenticate: Util.bind(this.authenticate, this)\n        }, true); // if the user has access to a callback they can handle the auth error\n\n        error.authenticate = Util.bind(this.authenticate, this);\n      }\n\n      callback.call(context, error, response);\n\n      if (error) {\n        this.fire('requesterror', {\n          url: this.options.url + path,\n          params: params,\n          message: error.message,\n          code: error.code,\n          method: method\n        }, true);\n      } else {\n        this.fire('requestsuccess', {\n          url: this.options.url + path,\n          params: params,\n          response: response,\n          method: method\n        }, true);\n      }\n\n      this.fire('requestend', {\n        url: this.options.url + path,\n        params: params,\n        method: method\n      }, true);\n    }, this);\n  },\n  _runQueue: function _runQueue() {\n    for (var i = this._requestQueue.length - 1; i >= 0; i--) {\n      var request = this._requestQueue[i];\n      var method = request.shift();\n      this[method].apply(this, request);\n    }\n\n    this._requestQueue = [];\n  }\n});\nexport function service(options) {\n  options = getUrlParams(options);\n  return new Service(options);\n}\nexport default service;","map":{"version":3,"sources":["D:/Web/mohi/client/node_modules/esri-leaflet/src/Services/Service.js"],"names":["Util","Evented","cors","cleanUrl","getUrlParams","Request","Service","extend","options","proxy","useCors","timeout","initialize","_requestQueue","_authenticating","setOptions","url","get","path","params","callback","context","_request","post","request","metadata","authenticate","token","_runQueue","getTimeout","setTimeout","method","fire","wrappedCallback","_createServiceCallback","requestParams","push","JSONP","bind","error","response","code","call","message","i","length","shift","apply","service"],"mappings":"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","sourcesContent":["import { Util, Evented } from 'leaflet';\r\nimport {cors} from '../Support';\r\nimport {cleanUrl, getUrlParams} from '../Util';\r\nimport Request from '../Request';\r\n\r\nexport var Service = Evented.extend({\r\n\r\n  options: {\r\n    proxy: false,\r\n    useCors: cors,\r\n    timeout: 0\r\n  },\r\n\r\n  initialize: function (options) {\r\n    options = options || {};\r\n    this._requestQueue = [];\r\n    this._authenticating = false;\r\n    Util.setOptions(this, options);\r\n    this.options.url = cleanUrl(this.options.url);\r\n  },\r\n\r\n  get: function (path, params, callback, context) {\r\n    return this._request('get', path, params, callback, context);\r\n  },\r\n\r\n  post: function (path, params, callback, context) {\r\n    return this._request('post', path, params, callback, context);\r\n  },\r\n\r\n  request: function (path, params, callback, context) {\r\n    return this._request('request', path, params, callback, context);\r\n  },\r\n\r\n  metadata: function (callback, context) {\r\n    return this._request('get', '', {}, callback, context);\r\n  },\r\n\r\n  authenticate: function (token) {\r\n    this._authenticating = false;\r\n    this.options.token = token;\r\n    this._runQueue();\r\n    return this;\r\n  },\r\n\r\n  getTimeout: function () {\r\n    return this.options.timeout;\r\n  },\r\n\r\n  setTimeout: function (timeout) {\r\n    this.options.timeout = timeout;\r\n  },\r\n\r\n  _request: function (method, path, params, callback, context) {\r\n    this.fire('requeststart', {\r\n      url: this.options.url + path,\r\n      params: params,\r\n      method: method\r\n    }, true);\r\n\r\n    var wrappedCallback = this._createServiceCallback(method, path, params, callback, context);\r\n\r\n    if (this.options.token) {\r\n      params.token = this.options.token;\r\n    }\r\n    if (this.options.requestParams) {\r\n      Util.extend(params, this.options.requestParams);\r\n    }\r\n    if (this._authenticating) {\r\n      this._requestQueue.push([method, path, params, callback, context]);\r\n      return;\r\n    } else {\r\n      var url = (this.options.proxy) ? this.options.proxy + '?' + this.options.url + path : this.options.url + path;\r\n\r\n      if ((method === 'get' || method === 'request') && !this.options.useCors) {\r\n        return Request.get.JSONP(url, params, wrappedCallback, context);\r\n      } else {\r\n        return Request[method](url, params, wrappedCallback, context);\r\n      }\r\n    }\r\n  },\r\n\r\n  _createServiceCallback: function (method, path, params, callback, context) {\r\n    return Util.bind(function (error, response) {\r\n      if (error && (error.code === 499 || error.code === 498)) {\r\n        this._authenticating = true;\r\n\r\n        this._requestQueue.push([method, path, params, callback, context]);\r\n\r\n        // fire an event for users to handle and re-authenticate\r\n        this.fire('authenticationrequired', {\r\n          authenticate: Util.bind(this.authenticate, this)\r\n        }, true);\r\n\r\n        // if the user has access to a callback they can handle the auth error\r\n        error.authenticate = Util.bind(this.authenticate, this);\r\n      }\r\n\r\n      callback.call(context, error, response);\r\n\r\n      if (error) {\r\n        this.fire('requesterror', {\r\n          url: this.options.url + path,\r\n          params: params,\r\n          message: error.message,\r\n          code: error.code,\r\n          method: method\r\n        }, true);\r\n      } else {\r\n        this.fire('requestsuccess', {\r\n          url: this.options.url + path,\r\n          params: params,\r\n          response: response,\r\n          method: method\r\n        }, true);\r\n      }\r\n\r\n      this.fire('requestend', {\r\n        url: this.options.url + path,\r\n        params: params,\r\n        method: method\r\n      }, true);\r\n    }, this);\r\n  },\r\n\r\n  _runQueue: function () {\r\n    for (var i = this._requestQueue.length - 1; i >= 0; i--) {\r\n      var request = this._requestQueue[i];\r\n      var method = request.shift();\r\n      this[method].apply(this, request);\r\n    }\r\n    this._requestQueue = [];\r\n  }\r\n});\r\n\r\nexport function service (options) {\r\n  options = getUrlParams(options);\r\n  return new Service(options);\r\n}\r\n\r\nexport default service;\r\n"]},"metadata":{},"sourceType":"module"}