{"ast":null,"code":"import { Util } from 'leaflet';\nimport featureLayerService from '../../Services/FeatureLayerService';\nimport { getUrlParams, warn, setEsriAttribution } from '../../Util';\nimport { FeatureGrid } from './FeatureGrid';\nimport BinarySearchIndex from 'tiny-binary-search';\nexport var FeatureManager = FeatureGrid.extend({\n  /**\r\n   * Options\r\n   */\n  options: {\n    attribution: null,\n    where: '1=1',\n    fields: ['*'],\n    from: false,\n    to: false,\n    timeField: false,\n    timeFilterMode: 'server',\n    simplifyFactor: 0,\n    precision: 6,\n    fetchAllFeatures: false\n  },\n\n  /**\r\n   * Constructor\r\n   */\n  initialize: function (options) {\n    FeatureGrid.prototype.initialize.call(this, options);\n    options = getUrlParams(options);\n    options = Util.setOptions(this, options);\n    this.service = featureLayerService(options);\n    this.service.addEventParent(this); // use case insensitive regex to look for common fieldnames used for indexing\n\n    if (this.options.fields[0] !== '*') {\n      var oidCheck = false;\n\n      for (var i = 0; i < this.options.fields.length; i++) {\n        if (this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)) {\n          oidCheck = true;\n        }\n      }\n\n      if (oidCheck === false) {\n        warn('no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.');\n      }\n    }\n\n    if (this.options.timeField.start && this.options.timeField.end) {\n      this._startTimeIndex = new BinarySearchIndex();\n      this._endTimeIndex = new BinarySearchIndex();\n    } else if (this.options.timeField) {\n      this._timeIndex = new BinarySearchIndex();\n    }\n\n    this._cache = {};\n    this._currentSnapshot = []; // cache of what layers should be active\n\n    this._activeRequests = 0;\n  },\n\n  /**\r\n   * Layer Interface\r\n   */\n  onAdd: function (map) {\n    // include 'Powered by Esri' in map attribution\n    setEsriAttribution(map);\n    this.service.metadata(function (err, metadata) {\n      if (!err) {\n        var supportedFormats = metadata.supportedQueryFormats; // Check if someone has requested that we don't use geoJSON, even if it's available\n\n        var forceJsonFormat = false;\n\n        if (this.service.options.isModern === false || this.options.fetchAllFeatures) {\n          forceJsonFormat = true;\n        } // Unless we've been told otherwise, check to see whether service can emit GeoJSON natively\n\n\n        if (!forceJsonFormat && supportedFormats && supportedFormats.indexOf('geoJSON') !== -1) {\n          this.service.options.isModern = true;\n        }\n\n        if (metadata.objectIdField) {\n          this.service.options.idAttribute = metadata.objectIdField;\n        } // add copyright text listed in service metadata\n\n\n        if (!this.options.attribution && map.attributionControl && metadata.copyrightText) {\n          this.options.attribution = metadata.copyrightText;\n          map.attributionControl.addAttribution(this.getAttribution());\n        }\n      }\n    }, this);\n    map.on('zoomend', this._handleZoomChange, this);\n    return FeatureGrid.prototype.onAdd.call(this, map);\n  },\n  onRemove: function (map) {\n    map.off('zoomend', this._handleZoomChange, this);\n    return FeatureGrid.prototype.onRemove.call(this, map);\n  },\n  getAttribution: function () {\n    return this.options.attribution;\n  },\n\n  /**\r\n   * Feature Management\r\n   */\n  createCell: function (bounds, coords) {\n    // dont fetch features outside the scale range defined for the layer\n    if (this._visibleZoom()) {\n      this._requestFeatures(bounds, coords);\n    }\n  },\n  _requestFeatures: function (bounds, coords, callback, offset) {\n    this._activeRequests++; // default param\n\n    offset = offset || 0;\n    var originalWhere = this.options.where; // our first active request fires loading\n\n    if (this._activeRequests === 1) {\n      this.fire('loading', {\n        bounds: bounds\n      }, true);\n    }\n\n    return this._buildQuery(bounds, offset).run(function (error, featureCollection, response) {\n      if (response && response.exceededTransferLimit) {\n        this.fire('drawlimitexceeded');\n      } // the where changed while this request was being run so don't it.\n\n\n      if (this.options.where !== originalWhere) {\n        return;\n      } // no error, features\n\n\n      if (!error && featureCollection && featureCollection.features.length) {\n        // schedule adding features until the next animation frame\n        Util.requestAnimFrame(Util.bind(function () {\n          this._addFeatures(featureCollection.features, coords);\n\n          this._postProcessFeatures(bounds);\n        }, this));\n      } // no error, no features\n\n\n      if (!error && featureCollection && !featureCollection.features.length) {\n        this._postProcessFeatures(bounds);\n      }\n\n      if (error) {\n        this._postProcessFeatures(bounds);\n      }\n\n      if (callback) {\n        callback.call(this, error, featureCollection);\n      }\n\n      if (response && (response.exceededTransferLimit || response.properties && response.properties.exceededTransferLimit) && this.options.fetchAllFeatures) {\n        this._requestFeatures(bounds, coords, callback, offset + featureCollection.features.length);\n      }\n    }, this);\n  },\n  _postProcessFeatures: function (bounds) {\n    // deincrement the request counter now that we have processed features\n    this._activeRequests--; // if there are no more active requests fire a load event for this view\n\n    if (this._activeRequests <= 0) {\n      this.fire('load', {\n        bounds: bounds\n      });\n    }\n  },\n  _cacheKey: function (coords) {\n    return coords.z + ':' + coords.x + ':' + coords.y;\n  },\n  _addFeatures: function (features, coords) {\n    // coords is optional - will be false if coming from addFeatures() function\n    if (coords) {\n      var key = this._cacheKey(coords);\n\n      this._cache[key] = this._cache[key] || [];\n    }\n\n    for (var i = features.length - 1; i >= 0; i--) {\n      var id = features[i].id;\n\n      if (this._currentSnapshot.indexOf(id) === -1) {\n        this._currentSnapshot.push(id);\n      }\n\n      if (typeof key !== 'undefined' && this._cache[key].indexOf(id) === -1) {\n        this._cache[key].push(id);\n      }\n    }\n\n    if (this.options.timeField) {\n      this._buildTimeIndexes(features);\n    }\n\n    this.createLayers(features);\n  },\n  _buildQuery: function (bounds, offset) {\n    var query = this.service.query().intersects(bounds).where(this.options.where).fields(this.options.fields).precision(this.options.precision);\n\n    if (this.options.fetchAllFeatures && !isNaN(parseInt(offset))) {\n      query = query.offset(offset);\n    }\n\n    query.params['resultType'] = 'tile';\n\n    if (this.options.requestParams) {\n      Util.extend(query.params, this.options.requestParams);\n    }\n\n    if (this.options.simplifyFactor) {\n      query.simplify(this._map, this.options.simplifyFactor);\n    }\n\n    if (this.options.timeFilterMode === 'server' && this.options.from && this.options.to) {\n      query.between(this.options.from, this.options.to);\n    }\n\n    return query;\n  },\n\n  /**\r\n   * Where Methods\r\n   */\n  setWhere: function (where, callback, context) {\n    this.options.where = where && where.length ? where : '1=1';\n    var oldSnapshot = [];\n    var newSnapshot = [];\n    var pendingRequests = 0;\n    var requestError = null;\n    var requestCallback = Util.bind(function (error, featureCollection) {\n      if (error) {\n        requestError = error;\n      }\n\n      if (featureCollection) {\n        for (var i = featureCollection.features.length - 1; i >= 0; i--) {\n          newSnapshot.push(featureCollection.features[i].id);\n        }\n      }\n\n      pendingRequests--;\n\n      if (pendingRequests <= 0 && this._visibleZoom() && where === this.options.where // the where is still the same so use this one\n      ) {\n          this._currentSnapshot = newSnapshot; // schedule adding features for the next animation frame\n\n          Util.requestAnimFrame(Util.bind(function () {\n            this.removeLayers(oldSnapshot);\n            this.addLayers(newSnapshot);\n\n            if (callback) {\n              callback.call(context, requestError);\n            }\n          }, this));\n        }\n    }, this);\n\n    for (var i = this._currentSnapshot.length - 1; i >= 0; i--) {\n      oldSnapshot.push(this._currentSnapshot[i]);\n    }\n\n    this._cache = {};\n\n    for (var key in this._cells) {\n      pendingRequests++;\n\n      var coords = this._keyToCellCoords(key);\n\n      var bounds = this._cellCoordsToBounds(coords);\n\n      this._requestFeatures(bounds, coords, requestCallback);\n    }\n\n    return this;\n  },\n  getWhere: function () {\n    return this.options.where;\n  },\n\n  /**\r\n   * Time Range Methods\r\n   */\n  getTimeRange: function () {\n    return [this.options.from, this.options.to];\n  },\n  setTimeRange: function (from, to, callback, context) {\n    var oldFrom = this.options.from;\n    var oldTo = this.options.to;\n    var pendingRequests = 0;\n    var requestError = null;\n    var requestCallback = Util.bind(function (error) {\n      if (error) {\n        requestError = error;\n      }\n\n      this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n      pendingRequests--;\n\n      if (callback && pendingRequests <= 0) {\n        callback.call(context, requestError);\n      }\n    }, this);\n    this.options.from = from;\n    this.options.to = to;\n\n    this._filterExistingFeatures(oldFrom, oldTo, from, to);\n\n    if (this.options.timeFilterMode === 'server') {\n      for (var key in this._cells) {\n        pendingRequests++;\n\n        var coords = this._keyToCellCoords(key);\n\n        var bounds = this._cellCoordsToBounds(coords);\n\n        this._requestFeatures(bounds, coords, requestCallback);\n      }\n    }\n\n    return this;\n  },\n  refresh: function () {\n    this.setWhere(this.options.where);\n  },\n  _filterExistingFeatures: function (oldFrom, oldTo, newFrom, newTo) {\n    var layersToRemove = oldFrom && oldTo ? this._getFeaturesInTimeRange(oldFrom, oldTo) : this._currentSnapshot;\n\n    var layersToAdd = this._getFeaturesInTimeRange(newFrom, newTo);\n\n    if (layersToAdd.indexOf) {\n      for (var i = 0; i < layersToAdd.length; i++) {\n        var shouldRemoveLayer = layersToRemove.indexOf(layersToAdd[i]);\n\n        if (shouldRemoveLayer >= 0) {\n          layersToRemove.splice(shouldRemoveLayer, 1);\n        }\n      }\n    } // schedule adding features until the next animation frame\n\n\n    Util.requestAnimFrame(Util.bind(function () {\n      this.removeLayers(layersToRemove);\n      this.addLayers(layersToAdd);\n    }, this));\n  },\n  _getFeaturesInTimeRange: function (start, end) {\n    var ids = [];\n    var search;\n\n    if (this.options.timeField.start && this.options.timeField.end) {\n      var startTimes = this._startTimeIndex.between(start, end);\n\n      var endTimes = this._endTimeIndex.between(start, end);\n\n      search = startTimes.concat(endTimes);\n    } else if (this._timeIndex) {\n      search = this._timeIndex.between(start, end);\n    } else {\n      warn('You must set timeField in the layer constructor in order to manipulate the start and end time filter.');\n      return [];\n    }\n\n    for (var i = search.length - 1; i >= 0; i--) {\n      ids.push(search[i].id);\n    }\n\n    return ids;\n  },\n  _buildTimeIndexes: function (geojson) {\n    var i;\n    var feature;\n\n    if (this.options.timeField.start && this.options.timeField.end) {\n      var startTimeEntries = [];\n      var endTimeEntries = [];\n\n      for (i = geojson.length - 1; i >= 0; i--) {\n        feature = geojson[i];\n        startTimeEntries.push({\n          id: feature.id,\n          value: new Date(feature.properties[this.options.timeField.start])\n        });\n        endTimeEntries.push({\n          id: feature.id,\n          value: new Date(feature.properties[this.options.timeField.end])\n        });\n      }\n\n      this._startTimeIndex.bulkAdd(startTimeEntries);\n\n      this._endTimeIndex.bulkAdd(endTimeEntries);\n    } else {\n      var timeEntries = [];\n\n      for (i = geojson.length - 1; i >= 0; i--) {\n        feature = geojson[i];\n        timeEntries.push({\n          id: feature.id,\n          value: new Date(feature.properties[this.options.timeField])\n        });\n      }\n\n      this._timeIndex.bulkAdd(timeEntries);\n    }\n  },\n  _featureWithinTimeRange: function (feature) {\n    if (!this.options.from || !this.options.to) {\n      return true;\n    }\n\n    var from = +this.options.from.valueOf();\n    var to = +this.options.to.valueOf();\n\n    if (typeof this.options.timeField === 'string') {\n      var date = +feature.properties[this.options.timeField];\n      return date >= from && date <= to;\n    }\n\n    if (this.options.timeField.start && this.options.timeField.end) {\n      var startDate = +feature.properties[this.options.timeField.start];\n      var endDate = +feature.properties[this.options.timeField.end];\n      return startDate >= from && startDate <= to || endDate >= from && endDate <= to || startDate <= from && endDate >= to;\n    }\n  },\n  _visibleZoom: function () {\n    // check to see whether the current zoom level of the map is within the optional limit defined for the FeatureLayer\n    if (!this._map) {\n      return false;\n    }\n\n    var zoom = this._map.getZoom();\n\n    if (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\n      return false;\n    } else {\n      return true;\n    }\n  },\n  _handleZoomChange: function () {\n    if (!this._visibleZoom()) {\n      this.removeLayers(this._currentSnapshot);\n    } else {\n      /*\r\n      for every cell in this._cells\r\n        1. Get the cache key for the coords of the cell\r\n        2. If this._cache[key] exists it will be an array of feature IDs.\r\n        3. Call this.addLayers(this._cache[key]) to instruct the feature layer to add the layers back.\r\n      */\n      for (var i in this._cells) {\n        var coords = this._cells[i].coords;\n\n        var key = this._cacheKey(coords);\n\n        if (this._cache[key]) {\n          this.addLayers(this._cache[key]);\n        }\n      }\n    }\n  },\n\n  /**\r\n   * Service Methods\r\n   */\n  authenticate: function (token) {\n    this.service.authenticate(token);\n    return this;\n  },\n  metadata: function (callback, context) {\n    this.service.metadata(callback, context);\n    return this;\n  },\n  query: function () {\n    return this.service.query();\n  },\n  _getMetadata: function (callback) {\n    if (this._metadata) {\n      var error;\n      callback(error, this._metadata);\n    } else {\n      this.metadata(Util.bind(function (error, response) {\n        this._metadata = response;\n        callback(error, this._metadata);\n      }, this));\n    }\n  },\n  addFeature: function (feature, callback, context) {\n    this.addFeatures(feature, callback, context);\n  },\n  addFeatures: function (features, callback, context) {\n    this._getMetadata(Util.bind(function (error, metadata) {\n      if (error) {\n        if (callback) {\n          callback.call(this, error, null);\n        }\n\n        return;\n      } // GeoJSON featureCollection or simple feature\n\n\n      var featuresArray = features.features ? features.features : [features];\n      this.service.addFeatures(features, Util.bind(function (error, response) {\n        if (!error) {\n          for (var i = featuresArray.length - 1; i >= 0; i--) {\n            // assign ID from result to appropriate objectid field from service metadata\n            featuresArray[i].properties[metadata.objectIdField] = featuresArray.length > 1 ? response[i].objectId : response.objectId; // we also need to update the geojson id for createLayers() to function\n\n            featuresArray[i].id = featuresArray.length > 1 ? response[i].objectId : response.objectId;\n          }\n\n          this._addFeatures(featuresArray);\n        }\n\n        if (callback) {\n          callback.call(context, error, response);\n        }\n      }, this));\n    }, this));\n  },\n  updateFeature: function (feature, callback, context) {\n    this.updateFeatures(feature, callback, context);\n  },\n  updateFeatures: function (features, callback, context) {\n    // GeoJSON featureCollection or simple feature\n    var featuresArray = features.features ? features.features : [features];\n    this.service.updateFeatures(features, function (error, response) {\n      if (!error) {\n        for (var i = featuresArray.length - 1; i >= 0; i--) {\n          this.removeLayers([featuresArray[i].id], true);\n        }\n\n        this._addFeatures(featuresArray);\n      }\n\n      if (callback) {\n        callback.call(context, error, response);\n      }\n    }, this);\n  },\n  deleteFeature: function (id, callback, context) {\n    this.deleteFeatures(id, callback, context);\n  },\n  deleteFeatures: function (ids, callback, context) {\n    return this.service.deleteFeatures(ids, function (error, response) {\n      var responseArray = response.length ? response : [response];\n\n      if (!error && responseArray.length > 0) {\n        for (var i = responseArray.length - 1; i >= 0; i--) {\n          this.removeLayers([responseArray[i].objectId], true);\n        }\n      }\n\n      if (callback) {\n        callback.call(context, error, response);\n      }\n    }, this);\n  }\n});","map":{"version":3,"sources":["D:/Web/mohi/client/node_modules/esri-leaflet/src/Layers/FeatureLayer/FeatureManager.js"],"names":["Util","featureLayerService","getUrlParams","warn","setEsriAttribution","FeatureGrid","BinarySearchIndex","FeatureManager","extend","options","attribution","where","fields","from","to","timeField","timeFilterMode","simplifyFactor","precision","fetchAllFeatures","initialize","prototype","call","setOptions","service","addEventParent","oidCheck","i","length","match","start","end","_startTimeIndex","_endTimeIndex","_timeIndex","_cache","_currentSnapshot","_activeRequests","onAdd","map","metadata","err","supportedFormats","supportedQueryFormats","forceJsonFormat","isModern","indexOf","objectIdField","idAttribute","attributionControl","copyrightText","addAttribution","getAttribution","on","_handleZoomChange","onRemove","off","createCell","bounds","coords","_visibleZoom","_requestFeatures","callback","offset","originalWhere","fire","_buildQuery","run","error","featureCollection","response","exceededTransferLimit","features","requestAnimFrame","bind","_addFeatures","_postProcessFeatures","properties","_cacheKey","z","x","y","key","id","push","_buildTimeIndexes","createLayers","query","intersects","isNaN","parseInt","params","requestParams","simplify","_map","between","setWhere","context","oldSnapshot","newSnapshot","pendingRequests","requestError","requestCallback","removeLayers","addLayers","_cells","_keyToCellCoords","_cellCoordsToBounds","getWhere","getTimeRange","setTimeRange","oldFrom","oldTo","_filterExistingFeatures","refresh","newFrom","newTo","layersToRemove","_getFeaturesInTimeRange","layersToAdd","shouldRemoveLayer","splice","ids","search","startTimes","endTimes","concat","geojson","feature","startTimeEntries","endTimeEntries","value","Date","bulkAdd","timeEntries","_featureWithinTimeRange","valueOf","date","startDate","endDate","zoom","getZoom","maxZoom","minZoom","authenticate","token","_getMetadata","_metadata","addFeature","addFeatures","featuresArray","objectId","updateFeature","updateFeatures","deleteFeature","deleteFeatures","responseArray"],"mappings":"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","sourcesContent":["import { Util } from 'leaflet';\r\nimport featureLayerService from '../../Services/FeatureLayerService';\r\nimport { getUrlParams, warn, setEsriAttribution } from '../../Util';\r\nimport { FeatureGrid } from './FeatureGrid';\r\nimport BinarySearchIndex from 'tiny-binary-search';\r\n\r\nexport var FeatureManager = FeatureGrid.extend({\r\n  /**\r\n   * Options\r\n   */\r\n\r\n  options: {\r\n    attribution: null,\r\n    where: '1=1',\r\n    fields: ['*'],\r\n    from: false,\r\n    to: false,\r\n    timeField: false,\r\n    timeFilterMode: 'server',\r\n    simplifyFactor: 0,\r\n    precision: 6,\r\n    fetchAllFeatures: false\r\n  },\r\n\r\n  /**\r\n   * Constructor\r\n   */\r\n\r\n  initialize: function (options) {\r\n    FeatureGrid.prototype.initialize.call(this, options);\r\n\r\n    options = getUrlParams(options);\r\n    options = Util.setOptions(this, options);\r\n\r\n    this.service = featureLayerService(options);\r\n    this.service.addEventParent(this);\r\n\r\n    // use case insensitive regex to look for common fieldnames used for indexing\r\n    if (this.options.fields[0] !== '*') {\r\n      var oidCheck = false;\r\n      for (var i = 0; i < this.options.fields.length; i++) {\r\n        if (this.options.fields[i].match(/^(OBJECTID|FID|OID|ID)$/i)) {\r\n          oidCheck = true;\r\n        }\r\n      }\r\n      if (oidCheck === false) {\r\n        warn(\r\n          'no known esriFieldTypeOID field detected in fields Array.  Please add an attribute field containing unique IDs to ensure the layer can be drawn correctly.'\r\n        );\r\n      }\r\n    }\r\n\r\n    if (this.options.timeField.start && this.options.timeField.end) {\r\n      this._startTimeIndex = new BinarySearchIndex();\r\n      this._endTimeIndex = new BinarySearchIndex();\r\n    } else if (this.options.timeField) {\r\n      this._timeIndex = new BinarySearchIndex();\r\n    }\r\n\r\n    this._cache = {};\r\n    this._currentSnapshot = []; // cache of what layers should be active\r\n    this._activeRequests = 0;\r\n  },\r\n\r\n  /**\r\n   * Layer Interface\r\n   */\r\n\r\n  onAdd: function (map) {\r\n    // include 'Powered by Esri' in map attribution\r\n    setEsriAttribution(map);\r\n\r\n    this.service.metadata(function (err, metadata) {\r\n      if (!err) {\r\n        var supportedFormats = metadata.supportedQueryFormats;\r\n\r\n        // Check if someone has requested that we don't use geoJSON, even if it's available\r\n        var forceJsonFormat = false;\r\n        if (this.service.options.isModern === false || this.options.fetchAllFeatures) {\r\n          forceJsonFormat = true;\r\n        }\r\n\r\n        // Unless we've been told otherwise, check to see whether service can emit GeoJSON natively\r\n        if (\r\n          !forceJsonFormat &&\r\n          supportedFormats &&\r\n          supportedFormats.indexOf('geoJSON') !== -1\r\n        ) {\r\n          this.service.options.isModern = true;\r\n        }\r\n\r\n        if (metadata.objectIdField) {\r\n          this.service.options.idAttribute = metadata.objectIdField;\r\n        }\r\n\r\n        // add copyright text listed in service metadata\r\n        if (\r\n          !this.options.attribution &&\r\n          map.attributionControl &&\r\n          metadata.copyrightText\r\n        ) {\r\n          this.options.attribution = metadata.copyrightText;\r\n          map.attributionControl.addAttribution(this.getAttribution());\r\n        }\r\n      }\r\n    }, this);\r\n\r\n    map.on('zoomend', this._handleZoomChange, this);\r\n\r\n    return FeatureGrid.prototype.onAdd.call(this, map);\r\n  },\r\n\r\n  onRemove: function (map) {\r\n    map.off('zoomend', this._handleZoomChange, this);\r\n\r\n    return FeatureGrid.prototype.onRemove.call(this, map);\r\n  },\r\n\r\n  getAttribution: function () {\r\n    return this.options.attribution;\r\n  },\r\n\r\n  /**\r\n   * Feature Management\r\n   */\r\n\r\n  createCell: function (bounds, coords) {\r\n    // dont fetch features outside the scale range defined for the layer\r\n    if (this._visibleZoom()) {\r\n      this._requestFeatures(bounds, coords);\r\n    }\r\n  },\r\n\r\n  _requestFeatures: function (bounds, coords, callback, offset) {\r\n    this._activeRequests++;\r\n\r\n    // default param\r\n    offset = offset || 0;\r\n\r\n    var originalWhere = this.options.where;\r\n\r\n    // our first active request fires loading\r\n    if (this._activeRequests === 1) {\r\n      this.fire(\r\n        'loading',\r\n        {\r\n          bounds: bounds\r\n        },\r\n        true\r\n      );\r\n    }\r\n\r\n    return this._buildQuery(bounds, offset).run(function (\r\n      error,\r\n      featureCollection,\r\n      response\r\n    ) {\r\n      if (response && response.exceededTransferLimit) {\r\n        this.fire('drawlimitexceeded');\r\n      }\r\n\r\n      // the where changed while this request was being run so don't it.\r\n      if (this.options.where !== originalWhere) {\r\n        return;\r\n      }\r\n\r\n      // no error, features\r\n      if (!error && featureCollection && featureCollection.features.length) {\r\n        // schedule adding features until the next animation frame\r\n        Util.requestAnimFrame(\r\n          Util.bind(function () {\r\n            this._addFeatures(featureCollection.features, coords);\r\n            this._postProcessFeatures(bounds);\r\n          }, this)\r\n        );\r\n      }\r\n\r\n      // no error, no features\r\n      if (!error && featureCollection && !featureCollection.features.length) {\r\n        this._postProcessFeatures(bounds);\r\n      }\r\n\r\n      if (error) {\r\n        this._postProcessFeatures(bounds);\r\n      }\r\n\r\n      if (callback) {\r\n        callback.call(this, error, featureCollection);\r\n      }\r\n      if (response && (response.exceededTransferLimit || (response.properties && response.properties.exceededTransferLimit)) && this.options.fetchAllFeatures) {\r\n        this._requestFeatures(bounds, coords, callback, offset + featureCollection.features.length);\r\n      }\r\n    },\r\n      this);\r\n  },\r\n\r\n  _postProcessFeatures: function (bounds) {\r\n    // deincrement the request counter now that we have processed features\r\n    this._activeRequests--;\r\n\r\n    // if there are no more active requests fire a load event for this view\r\n    if (this._activeRequests <= 0) {\r\n      this.fire('load', {\r\n        bounds: bounds\r\n      });\r\n    }\r\n  },\r\n\r\n  _cacheKey: function (coords) {\r\n    return coords.z + ':' + coords.x + ':' + coords.y;\r\n  },\r\n\r\n  _addFeatures: function (features, coords) {\r\n    // coords is optional - will be false if coming from addFeatures() function\r\n    if (coords) {\r\n      var key = this._cacheKey(coords);\r\n      this._cache[key] = this._cache[key] || [];\r\n    }\r\n\r\n    for (var i = features.length - 1; i >= 0; i--) {\r\n      var id = features[i].id;\r\n\r\n      if (this._currentSnapshot.indexOf(id) === -1) {\r\n        this._currentSnapshot.push(id);\r\n      }\r\n      if (typeof key !== 'undefined' && this._cache[key].indexOf(id) === -1) {\r\n        this._cache[key].push(id);\r\n      }\r\n    }\r\n\r\n    if (this.options.timeField) {\r\n      this._buildTimeIndexes(features);\r\n    }\r\n\r\n    this.createLayers(features);\r\n  },\r\n\r\n  _buildQuery: function (bounds, offset) {\r\n    var query = this.service\r\n      .query()\r\n      .intersects(bounds)\r\n      .where(this.options.where)\r\n      .fields(this.options.fields)\r\n      .precision(this.options.precision);\r\n\r\n    if (this.options.fetchAllFeatures && !isNaN(parseInt(offset))) {\r\n      query = query.offset(offset);\r\n    }\r\n\r\n    query.params['resultType'] = 'tile';\r\n\r\n    if (this.options.requestParams) {\r\n      Util.extend(query.params, this.options.requestParams);\r\n    }\r\n\r\n    if (this.options.simplifyFactor) {\r\n      query.simplify(this._map, this.options.simplifyFactor);\r\n    }\r\n\r\n    if (\r\n      this.options.timeFilterMode === 'server' &&\r\n      this.options.from &&\r\n      this.options.to\r\n    ) {\r\n      query.between(this.options.from, this.options.to);\r\n    }\r\n\r\n    return query;\r\n  },\r\n\r\n  /**\r\n   * Where Methods\r\n   */\r\n\r\n  setWhere: function (where, callback, context) {\r\n    this.options.where = where && where.length ? where : '1=1';\r\n\r\n    var oldSnapshot = [];\r\n    var newSnapshot = [];\r\n    var pendingRequests = 0;\r\n    var requestError = null;\r\n    var requestCallback = Util.bind(function (error, featureCollection) {\r\n      if (error) {\r\n        requestError = error;\r\n      }\r\n\r\n      if (featureCollection) {\r\n        for (var i = featureCollection.features.length - 1; i >= 0; i--) {\r\n          newSnapshot.push(featureCollection.features[i].id);\r\n        }\r\n      }\r\n\r\n      pendingRequests--;\r\n\r\n      if (\r\n        pendingRequests <= 0 &&\r\n        this._visibleZoom() &&\r\n        where === this.options.where // the where is still the same so use this one\r\n      ) {\r\n        this._currentSnapshot = newSnapshot;\r\n        // schedule adding features for the next animation frame\r\n        Util.requestAnimFrame(\r\n          Util.bind(function () {\r\n            this.removeLayers(oldSnapshot);\r\n            this.addLayers(newSnapshot);\r\n            if (callback) {\r\n              callback.call(context, requestError);\r\n            }\r\n          }, this)\r\n        );\r\n      }\r\n    }, this);\r\n\r\n    for (var i = this._currentSnapshot.length - 1; i >= 0; i--) {\r\n      oldSnapshot.push(this._currentSnapshot[i]);\r\n    }\r\n\r\n    this._cache = {};\r\n\r\n    for (var key in this._cells) {\r\n      pendingRequests++;\r\n      var coords = this._keyToCellCoords(key);\r\n      var bounds = this._cellCoordsToBounds(coords);\r\n      this._requestFeatures(bounds, coords, requestCallback);\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  getWhere: function () {\r\n    return this.options.where;\r\n  },\r\n\r\n  /**\r\n   * Time Range Methods\r\n   */\r\n\r\n  getTimeRange: function () {\r\n    return [this.options.from, this.options.to];\r\n  },\r\n\r\n  setTimeRange: function (from, to, callback, context) {\r\n    var oldFrom = this.options.from;\r\n    var oldTo = this.options.to;\r\n    var pendingRequests = 0;\r\n    var requestError = null;\r\n    var requestCallback = Util.bind(function (error) {\r\n      if (error) {\r\n        requestError = error;\r\n      }\r\n      this._filterExistingFeatures(oldFrom, oldTo, from, to);\r\n\r\n      pendingRequests--;\r\n\r\n      if (callback && pendingRequests <= 0) {\r\n        callback.call(context, requestError);\r\n      }\r\n    }, this);\r\n\r\n    this.options.from = from;\r\n    this.options.to = to;\r\n\r\n    this._filterExistingFeatures(oldFrom, oldTo, from, to);\r\n\r\n    if (this.options.timeFilterMode === 'server') {\r\n      for (var key in this._cells) {\r\n        pendingRequests++;\r\n        var coords = this._keyToCellCoords(key);\r\n        var bounds = this._cellCoordsToBounds(coords);\r\n        this._requestFeatures(bounds, coords, requestCallback);\r\n      }\r\n    }\r\n\r\n    return this;\r\n  },\r\n\r\n  refresh: function () {\r\n    this.setWhere(this.options.where);\r\n  },\r\n\r\n  _filterExistingFeatures: function (oldFrom, oldTo, newFrom, newTo) {\r\n    var layersToRemove =\r\n      oldFrom && oldTo\r\n        ? this._getFeaturesInTimeRange(oldFrom, oldTo)\r\n        : this._currentSnapshot;\r\n    var layersToAdd = this._getFeaturesInTimeRange(newFrom, newTo);\r\n\r\n    if (layersToAdd.indexOf) {\r\n      for (var i = 0; i < layersToAdd.length; i++) {\r\n        var shouldRemoveLayer = layersToRemove.indexOf(layersToAdd[i]);\r\n        if (shouldRemoveLayer >= 0) {\r\n          layersToRemove.splice(shouldRemoveLayer, 1);\r\n        }\r\n      }\r\n    }\r\n\r\n    // schedule adding features until the next animation frame\r\n    Util.requestAnimFrame(\r\n      Util.bind(function () {\r\n        this.removeLayers(layersToRemove);\r\n        this.addLayers(layersToAdd);\r\n      }, this)\r\n    );\r\n  },\r\n\r\n  _getFeaturesInTimeRange: function (start, end) {\r\n    var ids = [];\r\n    var search;\r\n\r\n    if (this.options.timeField.start && this.options.timeField.end) {\r\n      var startTimes = this._startTimeIndex.between(start, end);\r\n      var endTimes = this._endTimeIndex.between(start, end);\r\n      search = startTimes.concat(endTimes);\r\n    } else if (this._timeIndex) {\r\n      search = this._timeIndex.between(start, end);\r\n    } else {\r\n      warn(\r\n        'You must set timeField in the layer constructor in order to manipulate the start and end time filter.'\r\n      );\r\n      return [];\r\n    }\r\n\r\n    for (var i = search.length - 1; i >= 0; i--) {\r\n      ids.push(search[i].id);\r\n    }\r\n\r\n    return ids;\r\n  },\r\n\r\n  _buildTimeIndexes: function (geojson) {\r\n    var i;\r\n    var feature;\r\n    if (this.options.timeField.start && this.options.timeField.end) {\r\n      var startTimeEntries = [];\r\n      var endTimeEntries = [];\r\n      for (i = geojson.length - 1; i >= 0; i--) {\r\n        feature = geojson[i];\r\n        startTimeEntries.push({\r\n          id: feature.id,\r\n          value: new Date(feature.properties[this.options.timeField.start])\r\n        });\r\n        endTimeEntries.push({\r\n          id: feature.id,\r\n          value: new Date(feature.properties[this.options.timeField.end])\r\n        });\r\n      }\r\n      this._startTimeIndex.bulkAdd(startTimeEntries);\r\n      this._endTimeIndex.bulkAdd(endTimeEntries);\r\n    } else {\r\n      var timeEntries = [];\r\n      for (i = geojson.length - 1; i >= 0; i--) {\r\n        feature = geojson[i];\r\n        timeEntries.push({\r\n          id: feature.id,\r\n          value: new Date(feature.properties[this.options.timeField])\r\n        });\r\n      }\r\n\r\n      this._timeIndex.bulkAdd(timeEntries);\r\n    }\r\n  },\r\n\r\n  _featureWithinTimeRange: function (feature) {\r\n    if (!this.options.from || !this.options.to) {\r\n      return true;\r\n    }\r\n\r\n    var from = +this.options.from.valueOf();\r\n    var to = +this.options.to.valueOf();\r\n\r\n    if (typeof this.options.timeField === 'string') {\r\n      var date = +feature.properties[this.options.timeField];\r\n      return date >= from && date <= to;\r\n    }\r\n\r\n    if (this.options.timeField.start && this.options.timeField.end) {\r\n      var startDate = +feature.properties[this.options.timeField.start];\r\n      var endDate = +feature.properties[this.options.timeField.end];\r\n      return (\r\n        (startDate >= from && startDate <= to) ||\r\n        (endDate >= from && endDate <= to) ||\r\n        (startDate <= from && endDate >= to)\r\n      );\r\n    }\r\n  },\r\n\r\n  _visibleZoom: function () {\r\n    // check to see whether the current zoom level of the map is within the optional limit defined for the FeatureLayer\r\n    if (!this._map) {\r\n      return false;\r\n    }\r\n    var zoom = this._map.getZoom();\r\n    if (zoom > this.options.maxZoom || zoom < this.options.minZoom) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  },\r\n\r\n  _handleZoomChange: function () {\r\n    if (!this._visibleZoom()) {\r\n      this.removeLayers(this._currentSnapshot);\r\n    } else {\r\n      /*\r\n      for every cell in this._cells\r\n        1. Get the cache key for the coords of the cell\r\n        2. If this._cache[key] exists it will be an array of feature IDs.\r\n        3. Call this.addLayers(this._cache[key]) to instruct the feature layer to add the layers back.\r\n      */\r\n      for (var i in this._cells) {\r\n        var coords = this._cells[i].coords;\r\n        var key = this._cacheKey(coords);\r\n        if (this._cache[key]) {\r\n          this.addLayers(this._cache[key]);\r\n        }\r\n      }\r\n    }\r\n  },\r\n\r\n  /**\r\n   * Service Methods\r\n   */\r\n\r\n  authenticate: function (token) {\r\n    this.service.authenticate(token);\r\n    return this;\r\n  },\r\n\r\n  metadata: function (callback, context) {\r\n    this.service.metadata(callback, context);\r\n    return this;\r\n  },\r\n\r\n  query: function () {\r\n    return this.service.query();\r\n  },\r\n\r\n  _getMetadata: function (callback) {\r\n    if (this._metadata) {\r\n      var error;\r\n      callback(error, this._metadata);\r\n    } else {\r\n      this.metadata(\r\n        Util.bind(function (error, response) {\r\n          this._metadata = response;\r\n          callback(error, this._metadata);\r\n        }, this)\r\n      );\r\n    }\r\n  },\r\n\r\n  addFeature: function (feature, callback, context) {\r\n    this.addFeatures(feature, callback, context);\r\n  },\r\n\r\n  addFeatures: function (features, callback, context) {\r\n    this._getMetadata(\r\n      Util.bind(function (error, metadata) {\r\n        if (error) {\r\n          if (callback) {\r\n            callback.call(this, error, null);\r\n          }\r\n          return;\r\n        }\r\n        // GeoJSON featureCollection or simple feature\r\n        var featuresArray = features.features ? features.features : [features];\r\n\r\n        this.service.addFeatures(\r\n          features,\r\n          Util.bind(function (error, response) {\r\n            if (!error) {\r\n              for (var i = featuresArray.length - 1; i >= 0; i--) {\r\n                // assign ID from result to appropriate objectid field from service metadata\r\n                featuresArray[i].properties[metadata.objectIdField] =\r\n                  featuresArray.length > 1\r\n                    ? response[i].objectId\r\n                    : response.objectId;\r\n                // we also need to update the geojson id for createLayers() to function\r\n                featuresArray[i].id =\r\n                  featuresArray.length > 1\r\n                    ? response[i].objectId\r\n                    : response.objectId;\r\n              }\r\n              this._addFeatures(featuresArray);\r\n            }\r\n\r\n            if (callback) {\r\n              callback.call(context, error, response);\r\n            }\r\n          }, this)\r\n        );\r\n      }, this)\r\n    );\r\n  },\r\n\r\n  updateFeature: function (feature, callback, context) {\r\n    this.updateFeatures(feature, callback, context);\r\n  },\r\n\r\n  updateFeatures: function (features, callback, context) {\r\n    // GeoJSON featureCollection or simple feature\r\n    var featuresArray = features.features ? features.features : [features];\r\n    this.service.updateFeatures(\r\n      features,\r\n      function (error, response) {\r\n        if (!error) {\r\n          for (var i = featuresArray.length - 1; i >= 0; i--) {\r\n            this.removeLayers([featuresArray[i].id], true);\r\n          }\r\n          this._addFeatures(featuresArray);\r\n        }\r\n\r\n        if (callback) {\r\n          callback.call(context, error, response);\r\n        }\r\n      },\r\n      this\r\n    );\r\n  },\r\n\r\n  deleteFeature: function (id, callback, context) {\r\n    this.deleteFeatures(id, callback, context);\r\n  },\r\n\r\n  deleteFeatures: function (ids, callback, context) {\r\n    return this.service.deleteFeatures(\r\n      ids,\r\n      function (error, response) {\r\n        var responseArray = response.length ? response : [response];\r\n        if (!error && responseArray.length > 0) {\r\n          for (var i = responseArray.length - 1; i >= 0; i--) {\r\n            this.removeLayers([responseArray[i].objectId], true);\r\n          }\r\n        }\r\n        if (callback) {\r\n          callback.call(context, error, response);\r\n        }\r\n      },\r\n      this\r\n    );\r\n  }\r\n});\r\n"]},"metadata":{},"sourceType":"module"}